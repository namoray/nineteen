version: "3"

tasks:

  set_weights:
    cmds:
      - docker compose --env-file .vali.env -f docker-compose.yml run -e LOCALHOST=false --entrypoint "python src/cycle/calculate_and_schedule_weights.py" control_node
  control_node_dev:
    cmds:
      - ENV_FILE=.vali.env python -m validator.control_node.src.main
  
  query_node_dev:
    cmds: 
      - ENV_FILE=.vali.env python -m validator.query_node.src.main

  entry_node_dev:
    cmds:
      - uvicorn validator.entry_node.src.server:app --reload --host 0.0.0.0 --port 8091 --env-file .vali.env

  dev_setup:
    cmds:
      - echo "LOCALHOST=true" >> .vali.env
      - docker compose --env-file .vali.env -f docker-compose.yml -f docker-compose.dev.yml up -d --build
      - docker stop control_node query_node entry_node
      # Now use control_node_dev etc

  m1_dev:
    cmds:
      - ENV=DEV uvicorn miner.server:app --reload --host 0.0.0.0 --port 4001 --env-file .1.env --log-level debug

  m2_dev:
    cmds:
      - ENV=DEV uvicorn miner.server:app --reload --host 0.0.0.0 --port 4002 --env-file .2.env --log-level debug

  update_docker_fiber_version:
    cmds:
      - docker run --rm nineteen-control_node sh -c "pip install git+https://github.com/rayonlabs/fiber.git@0.0.2 --upgrade"
      - docker run --rm nineteen-entry_node sh -c "pip install git+https://github.com/rayonlabs/fiber.git@0.0.2 --upgrade"
      - docker run --rm nineteen-query_node sh -c "pip install git+https://github.com/rayonlabs/fiber.git@0.0.2 --upgrade"

  createm:
    cmds:
      - bash start_miners.sh
